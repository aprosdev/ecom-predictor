1. [Purpose](#markdown-header-purpose)
2. [Endpoints](#markdown-header-purpose)
    1. [Authorizations](#markdown-header-authorizations)
    2. [Create task](#markdown-header-create-task)
    3. [Check task state](#markdown-header-check-task-state)
3. [Dashboard](#markdown-header-dashboard)
4. Retailers
    1. [Amazon](#markdown-header-amazon)
    2. [Walmart](#markdown-header-walmart)
5. [Reviews](#markdown-header-reviews)
6. [Deploy API](#markdown-header-deploy-api)
7. [Development endpoint run](#markdown-header-development-endpoint-run)
8. [Add new retailer](#markdown-header-developing-spider-for-new-retailer)

# Purpose #

* Crawl and store product reviews
* Repeat crawls every day automatically
* Return reviews via API interface
* Allow manage products via admin dashboard

# Endpoints #

API is asynchronous. After creating task it is placed in processing queue.

## Authorizations ##

Request must contain HTTP header `X-API-KEY` with API key value (default: `fh482pa84x63kgoryx52`)

## Create task ##

Method: `POST`

Content-Type: `application/json`

Development endpoint (for prelim QA):

* http://apitest.contentanalyticsinc.com:8080/api/v1/tasks

Production endpoint:

* http://apitest.contentanalyticsinc.com/api/v1/tasks

Example:

```
#!js

{
    "retailer": "amazon",
    "product_id": "B00HZYBM9W",
    "product_url": null,
    "from_date": null,
    "daily": false
}
```

Arguments description:

* retailer - retailer name like **amazon** or **walmart**
* product_id - unique id to identity product. It could be ASIN, UPC, GTIN. It could be any other type if retailer's spider is using **product_url** for crawl
* product_url - some spiders like **amazon** are using **product_id** for crawl and url is optional argument. Some of spiders like **walmart** require url because it contains unique product id. In this case **product_id** could be equal value generated by sender
* from_date - optional argument to not crawl old reviews. Format YYYY-MM-DD
* daily - boolean value to repeat task every day

Example answer:

```
#!js

{
    "task_id": "59f002d4a2d09c7441869ed0", 
    "status": "received"
}
```

Check `message` field if status is `error`.

Use **task_id** to check task progress.

## Check task state ##

Method: `GET`

Development endpoint (for prelim QA):

* http://apitest.contentanalyticsinc.com:8080/api/v1/tasks/<task_id>

Production endpoints:

* http://apitest.contentanalyticsinc.com/api/v1/tasks/<task_id>

Example answer:

```
#!js

{
    "task_id": "59f002d4a2d09c7441869ed0",
    "status": "ready"
}
```

Possible states:

* received
* processing
* ready
* error

Check `message` field if status is `error`

# Dashboard #

Development: http://apitest.contentanalyticsinc.com:8080

Production: http://apitest.contentanalyticsinc.com

User **m1opzd83ba**, password **pl478dj430**

Dashboard allows:

* create task
* review tasks state
* disable daily tasks
* check product reviews
* export product reviews
* delete product reviews

# Amazon #

Spider: `amazon.py`

## Task options ##

Mandatory are **marked**:

* **retailer** - amazon
* **product_id** - ASIN
* product_url
* from_date - not crawl reviews older then date. Format YYYY-MM-DD
* daily - boolean value to repeat task every day

# Walmart #

Spider: `walmart.py`

## Task options ##

Mandatory are **marked**:

* **retailer** - amazon
* **product_id** - Tool ID or any other unique id like UPC
* product_url - product url, **mandatory** if UPC or any other unique value was used for product_id param
* from_date - not crawl reviews older then date. Format YYYY-MM-DD
* daily - boolean value to repeat task every day

# Reviews #

## Get reviews ##

Method: `GET`

Development endpoint (for prelim QA):

* http://apitest.contentanalyticsinc.com:8080/api/v1/<retailer>/<product_id>/reviews

Production endpoints:

* http://apitest.contentanalyticsinc.com/api/v1/<retailer>/<product_id>/reviews

Response format is JSON Lines - list of JSON objects with new line delimiter

**Pagination options (optional):**

* page - page number
* per_page - number of products per page

**Filter option (optional):**

You can specify GET argument `filter`: URL encoded JSON to filter MongoDB documents.

For example select reviews with rating 2 http://apitest.contentanalyticsinc.com/api/v1/<retailer>/<product_id>/reviews?filter=%7B%22rating%22%3A2%7D where filter is URL encoded JSON `{"rating":2}`. Filter reviews by several ratings `{"rating":{"$in":[1,2]}}`.

Filter to select reviews with `chocolate` in title `{"title":"chocolate"}`. All strings are processing as  regular expressions.

Filter for variants `{"variant.name":"Flavor","variant.value":"Variety Pack"}`

Review source objects via dashboard to prepare filters

**Sort option (optional):**

By default all reviews are sorted by date, but it could be changed with GET argument `sort`: URL encoded JSON to sort MongoDB documents.

JSON is an array of [field, direction] pairs. For example: `[["field1", 1], ["field2", -1]]` where `1` is ASCENDING and `-1` is DESCENDING order

### Total number of reviews ####

Return total number of reviews for product

GET argument `total`. Boolean: 1/0 or true/false

Example answer:

```
#!js

{
    "status": "success",
    "total": 123
}
```

It could be combined with `filter` argument

### List of variants ####

Return list of variants for product reviews

GET argument `variants`. Boolean: 1/0 or true/false

Example answer:

```
#!js

{
    "status": "success", 
    "variants": {
        "Color": [
            "Orange/Green", 
            "Green/Orange"
        ]
    }
}

```

It could be combined with `filter` and `total` argument

### Average rating ####

Calculates average rating on selected date

GET argument `avg_rating_date`. Format YYYY-MM-DD

Example answer:

```
#!js

{
    "status": "success",
    "avg_rating": 4.5
}
```

### Disable daily task ####

GET argument `not_daily`

Example answer:

```
#!js

{
    "status": "success"
}
```

### Words statistic ####

Return words statistic for the wordcloud

GET argument `words`. Integer: for example, 100.

Example answer:

```
#!js

{
    "status": "success", 
    "words": [
        {
            "count": 7204, 
            "positive_review": true, 
            "word": "wipes"
        }, 
        {
            "count": 2509, 
            "positive_review": true, 
            "word": "love"
        }, 
        {
            "count": 1932, 
            "positive_review": true, 
            "word": "great"
        }
    ]
}
```

Words are counting for positive ("positive_review": true) and negative reviews ("positive_review": false)

# Deploy API #

Server: apitest.contentanalyticsinc.com

Run **deploy.sh** script

## Development endpoint run ##

Run API frontend: 

```
#!bash

source ~/tmtextenv/bin/activate
cd ~/tmtext/review_api
kill `cat twistd.pid`
DEV_CONFIG=1 PYTHONPATH=~/tmtext/review_api ~/tmtextenv/bin/twistd web --port="tcp:8080" --wsgi app.app
```

Logs are in **twistd.log**

Run backend:

```
#!bash

source ~/tmtextenv/bin/activate
cd ~/tmtext/review_api
DEV_CONFIG=1 nohup celery -A app.crawler.celery worker --concurrency=1 -B >>celery.log 2>&1 &
```

Logs are in **celery.log**

# Developing spider for new retailer #

Add new spider in `spiders` directory with **retailer** property and **crawl** method: